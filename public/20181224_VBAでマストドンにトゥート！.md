---
title: VBAでマストドンにトゥート！
tags:
  - Excel
  - VBA
  - mastodon
private: false
updated_at: '2020-10-21T22:37:36+09:00'
id: 4ef2fad35a9b9fef8c97
organization_url_name: null
slide: false
ignorePublish: false
---
#VBAからマストドンにトゥートしてみよう！(全く需要なし)
やり方は簡単です。
まずソースコードを書く前に参照設定からMicrosoft XML, 6.0にチェックを付けます。
![image.png](https://qiita-image-store.s3.amazonaws.com/0/176021/79eb3e5a-70b4-48d7-8bc4-14014e136d97.png)

ではソースコードを書いていきます。

```vb:toot関数
Private Sub toot(status As String)
    Const ACCESS_TOKEN As String = "accessToken"
    Dim paramStr As String: paramStr = "&status=" & status
    Dim req As XMLHTTP60: Set req = New XMLHTTP60
    
    With req
        .Open "POST", "https://friends.nico/api/v1/statuses"
        .setRequestHeader "Content-Type", "application/x-www-form-urlencoded"
        .setRequestHeader "Authorization", "Bearer " & ACCESS_TOKEN
        .send paramStr
    End With

    Set req = Nothing
End Sub
```
これだけです。
```paramStr ```に、status(必須)等のパラメータを追記できます。
たとえば、デバッグ用にvisibilityを判定する関数を作って、それを追加なんてことも可能ですね。
詳しくはMastodonのドキュメント [statuses](https://docs.joinmastodon.org/methods/statuses/) の`Form Data Parameters`を確認してください。
ちなみに、`REQUIRED`と赤字で書いてあるパラメータは、その名の通り必須のため、送信する時はどれか必ずパラメータに入れなければなりません。
今回はstatuses(トゥート文字)を送る想定なので、パラメータ的には成立しています。
```OPTIONAL```は、必ずしもパラメータに入れる必要はありません。
VBAのデフォルト引数で書く```Optional```とほぼ意味は同じでしょう。

#参考サイト
- [エクセルVBAでHTTPリクエストをする最も簡単なプログラム](https://tonari-it.com/excel-vba-http-request/)
- [ExcelVBA、ExcelマクロからHTTPでPOSTする](http://piyopiyocs.blog115.fc2.com/blog-entry-433.html)

#最後に
これ、全く需要ないと思います(なんで書いた)

#追記① 2018/12/25
<s>レスポンスチェックを書いていなかったので一応記載します。
(正直VBAならトゥートされてればどうでもいい)</s>

~~```.send paramStr```の下に以下を記載します。~~

```vb:追記①
Do While .readyState < 4
    DoEvents
Loop
If .responseText Like "*error*" Then _
    MsgBox "エラー", vbOKOnly + vbCritical, "トゥート"
```

<s>JScripttypeinfoにはExistsはないんですかね？使い方がわからない…
解説としましては、```.readyState```が4になったら返事が帰ってきます。
その後、```.responseText```にレスポンスされたJSonが格納されていますので、
```error```があるかどうかをチェックします。(本当はパースした後ExistsでBooleanを返す関数を作りたかった)</s>

#追記② 2020/5/16
単純に```.status```を確認するだけでよかったみたいです。
追記①でもチェックはできますが、忘れてください。

```vb:追記②
Do While .readyState < 4
    DoEvents
Loop
If .status = 200 Then
    MsgBox "トゥートしました。", vbOKOnly + vbInformation, "トゥート！"
Else
    MsgBox "失敗しました。" & vbCrLf & "エラーコード：" & .status, vbOKOnly + vbCritical, "トゥート！"
End If
```
リクエスト結果が、200(成功)かどうかをチェックし、それ以外はエラーとしてみました。

#追記③ 2020/10/21
アクセストークンをURLからヘッダーに入れるよう変更しました。(上記toot関数修正済み)

```vb:変更前
Dim paramStr As String: paramStr = "&access_token=" & ACCESS_TOKEN & "&status=" & status
                                 ～中略～
With req
    .Open "POST", "https://friends.nico/api/v1/statuses"
    .setRequestHeader "Content-Type", "application/x-www-form-urlencoded"
    .send (paramStr)
```

```vb:変更後
Dim paramStr As String: paramStr = "&status=" & status
                                 ～中略～
With req
    .Open "POST", "https://friends.nico/api/v1/statuses"
    .setRequestHeader "Content-Type", "application/x-www-form-urlencoded"
    .setRequestHeader "Authorization", "Bearer " & ACCESS_TOKEN
    .send (paramStr)
```

セキュリティ的にまずいとのことなので、```.setRequestHeader``` に入れるよう修正しました。
そもそもなんでパラメータにアクセストークンを記載してもトゥートできるのが、API的に不思議という:thinking:
あとはちょこっとAPIに関するところも追記しました。
